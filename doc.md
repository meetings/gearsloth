## Daemon demo time

    $ gearmand & GEARMAN_PID=$!
    $ ./bin/gearslothd & GEARSLOTH_PID=$!
    $ ./examples/bin/log-delayed

    [0s] client 1: submitJobDelayed 3s 'log' 'than never'
    [0s] client 2: submitJobDelayed 2s 'log' 'is better'
    [0s] client 3: submitJobDelayedJson 1s 'log' 'late'
    [1s] worker: 'late'
    [2s] worker: 'is better'
    [3s] worker: 'than never'

    $ kill $GEARMAN_PID
    $ kill $GEARSLOTH_PID

## Introduction

Gearsloth is a system that enables delayed tasks and persistent storage schemes
in Gearman queue server. It consists of a small javascript helper library and a
daemon that functions as both a gearman worker listening to delayed tasks and a
client submitting those tasks at a specified time. The gearslothd daemon
supports a database backend architecture which abstracts persisting delayed
tasks to a database.

## Gearslothd daemon roles

Gearslothd daemon running as *injector* receives delayed tasks sent by gearsloth
clients. These are saved to a persistent store. Gearsloth *runners* then
receive pending tasks from the persistent store and send these forward at a
specified time to *controllers* whose job is to submit the task to the final
destination, wait for the completion/failure of the task and update the state
of the task to the persistent store. The single gearsloth daemon can function in
any of these three roles in any combination. Any number of daemons in any roles
can use the same database and function in the same gearman queue system.

### Controllers

Controllers encapsulate a specific task retry strategy which governs when and
how a failing task is retried/failed. Controllers publish a gearman function
which is called by runner on task expiry time to send the expiring task.
Gearslothd daemon implements a default controller but users can implement
custom controllers with custom retry strategies and choose the controller
they want to use on runtime by specifying the controller gearman function name
and a controller-specific configuration object when submitting a delayed task.

Custom controllers must expose a gearman function that accepts a task id
generated by the database and a freeform controller-dependent JSON configuration
object (specific API to be defined later).

It is up to the controller to update the fetch the task and update the state of
the task to the database on completion/failure, so implementors need to use the
database adapter in a compatible manner and provide a way for users to select
the appropriate adapter!

## Client interface (subject to change, strategies not implemented)

Gearsloth injector daemon adds the following functions to the gearman server:

### submitJobDelayed

Submits a task to be executed at a specified time.

Arguments:

* NULL byte terminated ascii timestamp string in RFC 2822 or ISO 8601 extended
  formats.
* NULL byte terminated name of the function that will be performed at a
  specified time.
* Payload that is sent to the specified function.

### submitJobDelayedJson

Submits a task to be executed at a specified time. The task is given as a
UTF-8 encoded JSON object. Optionally, binary payload can be sent by separating
it from the JSON object with a null byte. See `.payload_after_null_byte` from below.

JSON fields:

* `.at`: Timestamp string in RFC 2822 or ISO 8601 extended formats.
* `.func_name`: Name of the function that will be performed at a specified time.
* `.payload (optional)`: Payload (parameters) for the scheduled function.
* `.payload_after_null_byte (optional)`: If true, everything after the first null
  byte after the JSON object will be interpreted as the payload for the scheduled function.
  If this key is not set, but the JSON object is followed by extra data, an error
  will occur. If there is a payload defined in the JSON, and `.payload_after_null_byte` is true,
  the payload in the JSON will get overwritten.
* `.strategy (optional)`: String specifying the strategy
  function to be used when sending the task from runner. By
  default the strategy defined by gearslothd daemon is used.
* `.strategy_options (optional)`: Strategy-dependent
  JSON configuration object.

## Client helper library (subject to change, strategies not implemented)

The file 'lib/gearsloth.js' includes some helper functions for Javascript
clients which aid in encoding, decoding and validating gearsloth tasks.

### `encodeTask(String|Date|Number|Object at [, String|Buffer func_name] [, String|Buffer payload])` -> `Buffer`

Encodes and validates a task to be used as a payload with 'submitJobDelayed'
gearman function.

### `decodeTask(Buffer task)` -> `Object`

Decodes and validates a delayed task in binary format to a JSON task object.

### `encodeWithBinaryPayload(String|Object task, Buffer payload)` -> `Buffer`

Encodes a task and binary payload to a buffer, and sets `task.payload_after_null_byte` to true
in order to send them over gearman.

### `decodeJsonTask(String|Buffer task)` -> `Object`

Decodes and validates a delayed task to a JSON task object.

## Configuration

Gearslothd daemon by default reads a JSON configuration file gearsloth.json from
the current directory.

`./bin/gearslothd [options] [hostname[:port]]`

* `-i, --injector`: Run the daemon as injector.
* `-r, --runner`: Run the daemon as runner.
* `-c, --controller`: Run the daemon as default controller.
* `-f, --file=FILENAME`: Define the JSON configuration file. By default
  `gearsloth.json` in the currenct directory will be used. Options specified
  in this file are overwritten by any options defined by command line options.
* `    --conf=JSON`: Provide a JSON formatted configuration object on the
  command line. Any options defined by this object are overwritten by other
  command line options.
* `    --db=NAME`: Database adapter to be used by the daemon.
* `    --dbopt=JSON`: Provide a JSON formatted freefirn configuration object for
  the database adapter.
* `    --servers=JSON`: Provide a JSON formatted gearman server list array.
  The server list will be overwritten by a hostname given as a positional
  command line parameter.

### Configuration object formats

The specific configuration object formats are defined in `./validate.js`.
