## Introduction

Gearsloth is a system that enables delayed tasks and persistent storage schemes
in Gearman queue server. It consists of a small javascript helper library and a
daemon that functions as both a gearman worker listening to delayed tasks and a
client submitting those tasks at a specified time. The gearslothd daemon
supports a database backend architecture which abstracts persisting delayed
tasks to a database.

## Gearslothd daemon roles

Gearslothd daemon running as *injector* receives delayed tasks sent by gearsloth
clients. These are saved to a persistent storage. Gearsloth *runners* then
receive pending tasks from the persistent storage and send these forward at a
specified time to *controllers* whose job is to submit the task to the final
destination, wait for the completion/failure of the task and rely this
information to *ejectors*, which in turn will remove the task from the persistent store.

### Controllers

Controllers encapsulate a specific task retry strategy which governs when and
how a failing task is retried/failed. Controllers publish a gearman function
which is called by runner on task expiry time to send the expiring task.
Gearslothd daemon implements a default controller but users can implement
custom controllers with custom retry strategies and choose the controller
they want to use on runtime by specifying the controller gearman function name
and a controller-specific configuration object when submitting a delayed task.

Custom controllers must expose a gearman function that accepts a task id
generated by the database and a freeform controller-dependent JSON configuration
object (specific API to be defined later).

It is up to the controller to update the fetch the task and update the state of
the task to the database on completion/failure, so implementors need to use the
database adapter in a compatible manner and provide a way for users to select
the appropriate adapter!

## Client interface (subject to change, controllers not implemented)

Gearsloth injector daemon adds the following functions to the gearman server:

### submitJobDelayed

Submits a task to be executed at a specified time. The task is given as a
UTF-8 encoded JSON object.

See the [task format specification](Task format specification.md)

## Client helper library (subject to change, strategies not implemented)

The file 'lib/gearsloth.js' includes some helper functions for Javascript
clients which aid in encoding, decoding and validating gearsloth tasks.

**`encodeWithBinaryPayload(String|Object task, Buffer payload)` -> `Buffer`**

Encodes a task and binary payload to a buffer, and sets `task.payload_after_null_byte` to true
in order to send them over gearman.

**`decodeTask(String|Buffer task)` -> `Object`**

Decodes and validates a delayed task to a JSON task object.

## Configuration

Gearslothd daemon by default reads a JSON configuration file gearsloth.json from
the current directory.

`./bin/gearslothd [options] [hostname[:port]]`

* `-i, --injector`: Run the daemon as injector.
* `-r, --runner`: Run the daemon as runner.
* `-c, --controller`: Run the daemon as default controller.
* `-f, --file=FILENAME`: Define the JSON configuration file. By default
  `gearsloth.json` in the currenct directory will be used. Options specified
  in this file are overwritten by any options defined by command line options.
* `    --conf=JSON`: Provide a JSON formatted configuration object on the
  command line. Any options defined by this object are overwritten by other
  command line options.
* `    --db=NAME`: Database adapter to be used by the daemon.
* `    --dbopt=JSON`: Provide a JSON formatted freefirn configuration object for
  the database adapter.
* `    --servers=JSON`: Provide a JSON formatted gearman server list array.
  The server list will be overwritten by a hostname given as a positional
  command line parameter.

### Configuration object formats

The specific configuration object formats are defined in `./validate.js`.
